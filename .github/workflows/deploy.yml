name: Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e
            cd ${{ secrets.DEPLOY_PATH || '~/codeWS/Projects/mission-control' }}

            echo "=== Pulling latest changes ==="
            git fetch --all --tags
            git checkout ${{ github.event.release.tag_name || github.sha }}

            echo "=== Installing dependencies ==="
            pnpm install --frozen-lockfile

            echo "=== Building ==="
            pnpm build

            echo "=== Restarting service ==="
            # Restart via systemd if available, otherwise pm2/manual
            if systemctl --user is-active mission-control 2>/dev/null; then
              systemctl --user restart mission-control
            elif command -v pm2 &>/dev/null; then
              pm2 restart mission-control || pm2 start server.ts --name mission-control
            else
              # Kill existing and restart
              lsof -ti:3333 | xargs kill -9 2>/dev/null || true
              sleep 1
              nohup pnpm start --port 3333 > /tmp/mc.log 2>&1 &
            fi

            echo "=== Deploy complete ==="

# Mission Control Comprehensive Audit
**Date:** 2026-02-16 00:30 EST  
**Agent:** dev (KleinClaw-Code)  
**Model:** claude-opus-4-6  
**Requested by:** Klein  

---

## Executive Summary

Mission Control has significant issues across **stability, performance, and feature completeness**. The service was in a crash loop (restart counter at 1297) due to stale lock files, the WebSocket proxy floods the browser with events causing machine throttling, and several pages are broken or error-prone. Below is the full audit organized by severity.

---

## ðŸ”´ CRITICAL Issues

### C1: Service Crash Loop & Lock File Vulnerability
**Status:** FIXED (during this audit)  
**Impact:** Service was restart-looping 1297+ times

The systemd service runs `next dev` which creates `.next/dev/lock`. On crash or build conflicts, this lock file persists, causing every restart to fail immediately. The service then enters a rapid restart loop consuming CPU.

**Root Cause:** No lock cleanup in startup, no pre-start hook to clear stale locks.
**Fix:** Add a pre-start cleanup to the systemd unit OR add lock cleanup to server.ts startup.

### C2: WebSocket Event Flood â€” Machine Throttling
**Impact:** Klein's machine overloaded; the #1 performance issue

The WS proxy forwards EVERY gateway event to the browser â€” agent runs, chat messages, health pings, etc. During active agent work, this can be dozens of events per second. Each event:
1. Gets parsed by `handleMessage` â†’ triggers React state updates
2. Goes into `useRealtimeStore.addEvent()` â†’ causes React re-renders
3. Triggers subscriber callbacks â†’ more re-renders

The `server.ts` logs every proxied message to stdout (`console.log("[WS Proxy] Gateway ->"...)`), adding I/O overhead.

**Evidence:** During the audit, I saw 40+ `agent` + `chat` events in ~2 seconds.

### C3: Sessions Page â€” "missing scope: operator.read" Error
**Impact:** Sessions page errors on load; error toast shown

The Sessions page (`/sessions`) calls `request<{ sessions: Session[] }>("sessions.list", { limit: 100 })` via WebSocket. The gateway requires proper scoping for this method. When the request fails, the error at GatewayProvider.tsx:121 fires:
```
pending.reject(new Error(msg.error?.message || "Request failed"));
```
This surfaces as "missing scope: operator.read" in the UI.

**Dual Implementation Issue:** There's ALSO an HTTP API at `/api/sessions` that uses `openclaw sessions list --json` CLI â€” this one works fine. But the page uses the WebSocket version.

### C4: "Vector" Section Crashes Entire Website
**Impact:** Navigating to this section breaks the site

No "vector" or "embed" pages/routes exist in the codebase. Klein may be referring to:
- The **Evolver** page (`/evolver`) â€” which loads gene/capsule data
- A page that doesn't exist but is being navigated to (404 or client-side crash)

Need Klein to clarify which section. If it's a route that throws a client-side error, the React error boundary catches it and kills the whole SPA.

---

## ðŸŸ¡ MEDIUM Issues

### M1: OAuth vs API Auth Mode Not Properly Labeled
**Impact:** Klein can't distinguish authentication types at a glance

The `/api/agents` route attempts to infer auth mode from `config.auth.profiles` and `config.models.providers`, but the logic has issues:
1. It maps provider prefixes to auth modes, but many providers don't have explicit auth profiles
2. Falls back to "unknown" for most agents
3. The UI shows "?" for unknown auth modes

**Current logic:** `providerAuthMode[providerId] || "unknown"` â€” too many unknowns.

### M2: Sidebar Missing Pages
**Impact:** Velocity, Issues, and Analytics pages not accessible from nav

The sidebar navigation (`Sidebar.tsx`) lists only 8 items but the app has 12+ pages:
- Missing: `/velocity`, `/issues`, `/analytics`
- The old `dashboard/Sidebar.tsx` may have different nav

### M3: Personal vs Agent Task Separation Incomplete
**Impact:** Klein's personal tasks may leak into agent views

Per meta's gap doc, the Kanban board should show `agents` + `shared` by default with personal tasks in a collapsible sidebar panel. Current implementation filters by list in the API, but the UI needs verification.

### M4: No Server-Side Event Filtering
**Impact:** Contributes to C2 (event flood)

The WS proxy in `server.ts` passes ALL gateway events through without filtering. Events like `chat`, `agent.thinking`, and frequent `health` pings should be filtered server-side to only forward what the UI actually needs.

### M5: Console Logging in Production
**Impact:** I/O bottleneck, log spam

`server.ts` logs every proxied message (`[WS Proxy] Gateway ->`, `[WS Proxy] Client ->`). In dev mode this is fine, but in a systemd service running 24/7, this creates massive log files and I/O overhead.

### M6: Cron Page Works But Uses CLI Instead of WebSocket
**Impact:** Minor â€” functional but slow

The Cron page uses `/api/cron` which shells out to `openclaw cron list --all --json`. This works but is slower than WebSocket. The dashboard tries WebSocket first (`cron.list`) then falls back to HTTP â€” but individual pages don't.

---

## ðŸŸ¢ LOW Issues / Improvements

### L1: 30-Second Auto-Refresh on Dashboard
The dashboard polls every 30 seconds even when connected to WebSocket with real-time events. This is redundant and wastes resources.

### L2: Agents Cache TTL Too Short (5s)
The `/api/agents` route caches for only 5 seconds. Agent data doesn't change that fast â€” 30s would be more appropriate.

### L3: No Error Boundary Visible
The error notice Klein sees in the bottom-left suggests a client-side error boundary is catching something but the UX is poor.

### L4: Missing Velocity/Analytics Links in Sidebar
Pages exist but sidebar doesn't show them.

### L5: Build Passes Clean
No TypeScript errors, no warnings at build time. 41 routes, all compiling. This means all issues are runtime/logical, not compilation.

---

## Feature Gap Summary (from meta's doc + audit)

| Feature | Status | Priority |
|---------|--------|----------|
| Full-text search in MC | Missing | High |
| SLA breach indicators | Missing | Medium |
| Activity log per task | Missing in UI | Medium |
| Subtask tree view | Missing | Medium |
| Classification badges | Missing | Medium |
| Effort timer display | Missing | Low |
| Compressed session view | Missing | Low |
| Task deletion in UI | Missing | Medium |
| Intake approve/reject buttons | Missing | Medium |

---

## Proposed Fix Plan (Priority Order)

### Phase 1: Stability & Performance (CRITICAL)
1. **Fix lock file issue** â€” add pre-start cleanup to systemd unit + graceful lock handling in server.ts
2. **Implement server-side event filtering** â€” only forward events the UI subscribes to
3. **Reduce console logging** â€” conditional on NODE_ENV or log level
4. **Fix Sessions page** â€” switch from WS to HTTP API (like other pages do)
5. **Identify & fix "vector" crash** â€” need Klein clarification

### Phase 2: Auth & Display Fixes
6. **Fix OAuth vs API labeling** â€” improve auth mode detection logic
7. **Add missing sidebar links** â€” velocity, analytics, issues
8. **Reduce dashboard polling** â€” only poll when WS is disconnected

### Phase 3: oc-tasks Integration
9. **Add search bar** to Kanban
10. **Add task deletion** to UI
11. **Add classification badges** to task cards
12. **Ensure personal/agent list separation** in all views
13. **Add intake approve/reject buttons**

---

## Immediate Actions Taken

1. âœ… Cleared stale `.next/dev/lock` file
2. âœ… Killed orphan processes on ports 3333/9999
3. âœ… Service restarted and running cleanly
4. âœ… Full codebase audit complete
5. âœ… Meta's gap doc reviewed and integrated

---

## Files Reviewed

- `server.ts` â€” WS proxy, HTTP server
- `src/providers/GatewayProvider.tsx` â€” client WS connection
- `src/app/page.tsx` â€” dashboard
- `src/app/sessions/page.tsx` â€” sessions (broken)
- `src/app/cron/page.tsx` â€” cron monitor
- `src/app/evolver/page.tsx` â€” capability evolver
- `src/app/kanban/page.tsx` â€” kanban board (not fully reviewed)
- `src/app/api/agents/route.ts` â€” agents API
- `src/app/api/cron/route.ts` â€” cron API
- `src/app/api/sessions/route.ts` â€” sessions API
- `src/stores/realtime.ts` â€” event store
- `src/types/index.ts` â€” type definitions
- `src/components/layout/Sidebar.tsx` â€” navigation
- `docs/mc-vs-cli-gaps.md` â€” meta's gap analysis
- `docs/architecture.md` â€” system architecture
- `docs/oc-tasks-api.md` â€” API reference
